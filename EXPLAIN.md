# Запросы создания таблиц

## Document

```
CREATE TABLE public.document
(
id           BIGSERIAL PRIMARY KEY,
number       BIGSERIAL,
author       VARCHAR(40),
title        VARCHAR(40),
status       VARCHAR(16),
date_created TIMESTAMP WITH TIME ZONE,
date_updated TIMESTAMP WITH TIME ZONE
);
```

### Индекс B-tree на даты

```
CREATE INDEX document_dates
ON public.document (date_updated, date_created);
```

## History

```
CREATE TABLE public.history
(
id              BIGINT GENERATED BY DEFAULT AS IDENTITY
primary key,
initiator       VARCHAR(40),
action_date     TIMESTAMP WITH TIME ZONE,
document_id     BIGINT
CONSTRAINT document_reference
REFERENCES public.document
ON DELETE CASCADE,
document_action VARCHAR(16)
)
```

## Индекс B-tree на идентификатор документа

```
CREATE INDEX history_document_id_idx ON approval(document_id);
```

## History

```
CREATE TABLE public.approval
(
id            BIGSERIAL PRIMARY KEY,
document_id   BIGINT CONSTRAINT document_reference 
    REFERENCES public.document ON DELETE CASCADE,
    
approval_date TIMESTAMP WITH TIME ZONE
);
```

## Индекс B-tree на идентификатор документа
```
CREATE INDEX approval_document_id_idx ON approval(document_id);
```


## Индексы

Индексы на даты добавлены для ускорения поиска по датам.

Индексы на document_id добавлены для ускорения операций JOIN.

## Explain Analyze

### Запрос

```
EXPLAIN ANALYSE INSERT INTO document
(author, title, status, date_created, date_updated)
VALUES (:author, :title, :status, :date_created, :date_updated)
RETURNING id, number, author, title, status, date_created, date_updated
```

### Ответ

```
Insert on document  (cost=0.00..0.02 rows=1 width=278) 
    (actual time=3.555..3.556 rows=1 loops=1) 
-> Result  (cost=0.00..0.02 rows=1 width=278) 
    (actual time=2.320..2.320 rows=1 loops=1)
Planning Time: 0.086 ms
Execution Time: 3.593 ms
```

### Запрос

```
EXPLAIN ANALYSE SELECT * FROM document 
LEFT JOIN public.history h on document.id = h.document_id
```

### Ответ

```
Hash Right Join  (cost=15.85..30.92 rows=400 width=450) (actual time=0.130..0.164 rows=109 loops=1)
  Hash Cond: (h.document_id = document.id)
  ->  Seq Scan on history h  (cost=0.00..14.00 rows=400 width=172) (actual time=0.017..0.020 rows=28 loops=1)
  ->  Hash  (cost=12.60..12.60 rows=260 width=278) (actual time=0.081..0.082 rows=100 loops=1)
        Buckets: 1024  Batches: 1  Memory Usage: 16kB
        ->  Seq Scan on document  (cost=0.00..12.60 rows=260 width=278) (actual time=0.037..0.045 rows=100 loops=1)
Planning Time: 0.316 ms
Execution Time: 0.311 ms
```
